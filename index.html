<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Words App</title>
<style>
body { margin:0; font-family:-apple-system, BlinkMacSystemFont, sans-serif; background:#f2f4f7;}
header { background:#4a90e2; color:white; padding:16px; text-align:center; font-size:22px;}
.screen { display:none; padding:20px;}
.screen.active { display:block;}
.card { background:white; padding:20px; border-radius:14px;}
button { width:100%; padding:14px; margin:8px 0; font-size:18px; border:none; border-radius:12px; cursor:pointer;}
.primary { background:#4a90e2; color:white;}
.secondary { background:#e6e6e6;}
.back { background:transparent; color:#4a90e2; font-size:16px;}
.correct { background:#4caf50; color:white;}
.wrong { background:#f44336; color:white;}
.hidden { display:none; }
.word-box { text-align:center; margin:30px 0; position:relative; }
.english-word { font-size:32px; font-weight:bold; display:inline-block; }
.hebrew-word { font-size:26px; margin-top:10px; direction:rtl; color:#2c3e50; }
.progress { text-align:center; font-size:14px; color:#777; margin-bottom:10px;}
.choice-btn { background:#ffcc80; color:#3e2723; border:2px solid #fb8c00; border-radius:14px; margin:6px 0; font-weight:bold; font-size:18px; }
.choice-btn.correct { background:#4caf50; color:white; border:none;}
.choice-btn.wrong { background:#f44336; color:white; border:none;}
.speech-btn { position:absolute; right:-50px; top:0; background:#4a90e2; color:white; border-radius:50%; width:40px; height:40px; font-size:20px; line-height:40px; cursor:pointer; }
</style>
</head>
<body>

<header>My Words App</header>

<!-- ××¡×š ×¨××©×™ -->
<div id="home" class="screen active">
  <button class="primary" onclick="showScreen('add')">â• ×”×•×¡×¤×ª ××™×œ×”</button>
  <button class="primary" onclick="startPractice()">ğŸ¯ ×ª×¨×’×•×œ</button>
  <button class="primary" onclick="loadCSV()">ğŸ“‚ ×˜×¢×™× ×ª ×¨×©×™××”</button>
  <input type="file" id="csvFileInput" class="hidden" accept=".csv" onchange="handleCSV(event)">
</div>

<!-- ×”×•×¡×¤×ª ××™×œ×” -->
<div id="add" class="screen">
  <div class="card">
    <h2>×”×•×¡×¤×ª ××™×œ×”</h2>
    <input id="englishInput" placeholder="××™×œ×” ×‘×× ×’×œ×™×ª">
    <button class="secondary" onclick="translateOnline()">×ª×¨×’× online</button>
    <input id="hebrewInput" placeholder="×ª×¨×’×•× ×œ×¢×‘×¨×™×ª">
    <button class="primary" onclick="saveWord()">×©××•×¨</button>
    <button class="back" onclick="showScreen('home')">â¬… ×—×–×¨×”</button>
  </div>
</div>

<!-- ×ª×¨×’×•×œ -->
<div id="practice" class="screen">
  <div class="card">
    <div class="progress" id="progress"></div>
    <div class="word-box">
      <div class="english-word" id="currentWord"></div>
      <div class="hebrew-word hidden" id="translation"></div>
      <div class="speech-btn" onclick="speakWord()">ğŸ”Š</div>
    </div>

    <div id="choices" class="hidden"></div>

    <!-- ×’×¨×¡×” 1: ×œ××™×œ×” ×”×‘××” ×¨×’×™×œ×” -->
    <button id="nextBtnNormal" class="primary" onclick="nextWordNormal()">×œ××™×œ×” ×”×‘××”</button>
    <!-- ×’×¨×¡×” 2: ×œ××™×œ×” ×”×‘××” ××—×¨×™ ×¨×‘Ö¾×‘×¨×™×¨×” -->
    <button id="nextBtnChoice" class="primary hidden" onclick="nextWordAfterChoice()">×œ××™×œ×” ×”×‘××”</button>

    <button id="showTransBtn" class="secondary" onclick="showTranslation()">×”×¦×’ ×ª×¨×’×•×</button>
    <button id="showChoicesBtn" class="secondary" onclick="showChoices()">×”×¦×’ ××¤×©×¨×•×™×•×ª</button>
    <button class="secondary" onclick="hideCurrentWord()">×”×¡×ª×¨</button>

    <button class="back" onclick="showScreen('home')">â¬… ×—×–×¨×”</button>
  </div>
</div>

<script>
let words = JSON.parse(localStorage.getItem("words") || "[]");
let practiceList = [];
let index = 0;

function showScreen(id){
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// ×ª×¨×’×•× online
async function translateOnline(){
  const word = englishInput.value.trim();
  if(!word) return;
  const res = await fetch(`https://api.mymemory.translated.net/get?q=${word}&langpair=en|he`);
  const data = await res.json();
  hebrewInput.value = data.responseData.translatedText || "";
}

// ×©××™×¨×ª ××™×œ×”
function saveWord(){
  if(!englishInput.value || !hebrewInput.value) return;
  words.push({english:englishInput.value.trim(), hebrew:hebrewInput.value.trim(), hidden:false, score:0});
  localStorage.setItem("words", JSON.stringify(words));
  englishInput.value=""; hebrewInput.value="";
  alert("× ×©××¨");
  showScreen("home");
}

// ×˜×¢×™× ×ª CSV
function loadCSV() { document.getElementById("csvFileInput").click(); }

function handleCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const lines = e.target.result.split('\n');
    let addedCount=0;
    lines.forEach(line=>{
      const [eng,heb] = line.trim().split(',');
      if(!eng||!heb) return;
      if(!words.some(w=>w.english.toLowerCase()===eng.toLowerCase())){
        words.push({english:eng.trim(), hebrew:heb.trim(), hidden:false, score:0});
        addedCount++;
      }
    });
    localStorage.setItem("words", JSON.stringify(words));
    alert(`×”×•×¡×¤×• ${addedCount} ××™×œ×™× ×—×“×©×•×ª`);
  }
  reader.readAsText(file);
}

// ×ª×¨×’×•×œ ×¢× ××œ×’×•×¨×™×ª× ×—×“×©/×™×©×Ÿ (3:1)
function startPractice(){
  const newWords = words.filter(w=>!w.hidden && (w.score||0)===0);
  const oldWords = words.filter(w=>!w.hidden && (w.score||0)>0);

  practiceList=[];
  let iNew=0, iOld=0;
  while(iNew<newWords.length || iOld<oldWords.length){
    for(let k=0;k<3 && iNew<newWords.length;k++) practiceList.push(newWords[iNew++]);
    if(iOld<oldWords.length) practiceList.push(oldWords[iOld++]);
  }

  index=0;
  showCurrentWord();
  showScreen("practice");
}

// ×”×¦×’×ª ××™×œ×”
function showCurrentWord(){
  translation.classList.add("hidden");
  choices.innerHTML="";
  choices.classList.add("hidden");
  nextBtnNormal.style.display="inline-block";
  nextBtnChoice.classList.add("hidden");
  showTransBtn.disabled=false;
  showChoicesBtn.disabled=false;

  currentWord.innerText=practiceList[index].english;
  progress.innerText=`${index+1}/${practiceList.length}`;
}

// ×”×¦×’×ª ×ª×¨×’×•×
function showTranslation(){
  translation.innerText=practiceList[index].hebrew;
  translation.classList.remove("hidden");
}

// ×”×©××¢×ª ××™×œ×”
function speakWord(){
  const utter = new SpeechSynthesisUtterance(practiceList[index].english);
  utter.lang = 'en-US';
  speechSynthesis.speak(utter);
}

// ×”×¦×’×ª ××¤×©×¨×•×™×•×ª ×¨×‘Ö¾×‘×¨×™×¨×”
function showChoices(){
  choices.innerHTML="";
  choices.classList.remove("hidden");

  showTransBtn.disabled=true;
  showChoicesBtn.disabled=true;
  nextBtnNormal.style.display="none";
  nextBtnChoice.classList.remove("hidden");

  let correct = practiceList[index].hebrew;
  let options = [correct];
  let pool = words.filter(w=>w.hebrew!==correct);
  while(options.length<4 && pool.length){
    let r=pool.splice(Math.floor(Math.random()*pool.length),1)[0];
    options.push(r.hebrew);
  }
  options.sort(()=>Math.random()-0.5);

  options.forEach(opt=>{
    let btn=document.createElement("button");
    btn.innerText=opt;
    btn.className="choice-btn";
    btn.onclick=()=>handleChoice(btn,opt===correct);
    choices.appendChild(btn);
  });
}

function handleChoice(btn,isCorrect){
  [...choices.children].forEach(b=>b.disabled=true);
  if(isCorrect) btn.classList.add("correct");
  else {
    btn.classList.add("wrong");
    [...choices.children].forEach(b=>{if(b.innerText===practiceList[index].hebrew) b.classList.add("correct");});
  }
}

// ×’×¨×¡×” 1: ×œ××™×œ×” ×”×‘××” ×¨×’×™×œ×” (score++)
function nextWordNormal(){
  practiceList[index].score = (practiceList[index].score||0)+1;
  index++; if(index>=practiceList.length){ alert("×¡×™×•× ×ª×¨×’×•×œ"); showScreen("home"); return; }
  showCurrentWord();
}

// ×’×¨×¡×” 2: ×œ××™×œ×” ×”×‘××” ××—×¨×™ ×¨×‘Ö¾×‘×¨×™×¨×” (×œ×œ× ×©×™× ×•×™ × ×™×§×•×“)
function nextWordAfterChoice(){
  index++; if(index>=practiceList.length){ alert("×¡×™×•× ×ª×¨×’×•×œ"); showScreen("home"); return; }
  showCurrentWord();
}

// ×”×¡×ª×¨×ª ××™×œ×”
function hideCurrentWord(){
  practiceList[index].hidden=true;
  localStorage.setItem("words",JSON.stringify(words));
  nextWordNormal();
}
</script>
</body>
</html>
