<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>My Words App - Cloud Google Edition</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
:root {
    --primary: #2563eb;
    --primary-hover: #1d4ed8;
    --danger: #dc2626;
    --success: #16a34a;
    --warning: #f59e0b;
    --bg: #f8fafc;
    --card: #ffffff;
    --text: #1e293b;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--bg);
  margin: 0;
  color: var(--text);
  direction: ltr;
  -webkit-tap-highlight-color: transparent;
}

.screen { display: none; max-width: 700px; margin: auto; padding: 15px; animation: fadeIn 0.2s; }
.screen.active { display: block; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

h1 { text-align: center; color: var(--primary); font-size: 1.8rem; margin-top: 10px; }

.card { 
    background: var(--card); 
    padding: 20px; 
    border-radius: 16px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    margin-bottom: 15px;
}

button { 
    padding: 12px 15px; 
    font-size: 14px; 
    border-radius: 10px; 
    border: none; 
    cursor: pointer; 
    transition: all 0.2s;
    font-weight: 500;
}

button:active { transform: scale(0.96); }
.primary { background: var(--primary); color: #fff; }
.secondary { background: #e2e8f0; color: #475569; }
.danger { background: var(--danger); color: #fff; }
.main-buttons button { width: 100%; max-width: 300px; display: block; margin: 10px auto; }

/* Management */
.word-item { display: flex; flex-direction: column; padding: 12px; background: #fff; border-bottom: 1px solid #f1f5f9; }
.word-top { display: flex; justify-content: space-between; align-items: flex-start; }
.word-actions { display: flex; gap: 5px; margin-top: 8px; justify-content: flex-end; }
.action-btn { padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: bold; border: 1px solid #e2e8f0; background: #fff; color: #94a3b8; }
.action-btn.active-failed { background: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
.action-btn.active-success { background: #dcfce7; color: #15803d; border-color: #86efac; }
.action-btn.active-hidden { background: #fef3c7; color: #92400e; border-color: #fde68a; }

/* Practice */
.action-grid { display: flex; gap: 10px; justify-content: center; width: 100%; }
.action-grid button { flex: 1; min-width: 0; padding: 12px 5px; font-size: 13px; }
.word { font-size: 32px; text-align: center; margin: 15px 0; font-weight: bold; }
.translation { font-size: 22px; text-align: center; color: var(--primary); min-height: 1.5em; font-weight: 500;}
.options .option { padding: 12px; border-radius: 10px; background: #f1f5f9; margin: 8px 0; cursor: pointer; text-align: center; font-size: 15px; }
.option.correct { background: #dcfce7; border: 1px solid #22c55e; }
.option.wrong { background: #fee2e2; border: 1px solid #ef4444; }

.filter-bar { display: flex; gap: 6px; margin-bottom: 15px; overflow-x: auto; padding: 4px 0; }
.filter-chip { padding: 6px 12px; border-radius: 20px; font-size: 11px; background: #e2e8f0; color: #475569; cursor: pointer; white-space: nowrap; border: 1.5px solid transparent; }
.filter-chip.active { border-color: #94a3b8; font-weight: bold; }
input, select { box-sizing: border-box; }
</style>
</head>

<body>

<div class="screen active" id="login">
    <h1>My Words</h1>
    <div class="card" style="text-align:center;">
        <p>Login to sync your words across devices</p>
        <button class="primary" onclick="loginWithGoogle()" style="display:flex; align-items:center; justify-content:center; gap:10px;">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/pwa-apple-180x180.png" width="20" style="filter: brightness(0) invert(1);">
            Sign in with Google
        </button>
        <div id="authError" style="color:red; margin-top:10px; font-size:12px;"></div>
    </div>
</div>

<div class="screen" id="main">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h1 style="margin:0;">My Words</h1>
        <button class="secondary" onclick="logout()" style="width:auto; padding:5px 10px; font-size:11px;">Logout</button>
    </div>
    <div class="main-buttons">
        <button class="primary" onclick="go('add')">+ Add New Word</button>
        <button class="primary" onclick="go('practiceSetup')">üéØ Practice Now</button>
        <button class="secondary" onclick="openManage()">üìã Manage Database</button>
        <hr style="border:0; border-top:1px solid #e2e8f0; margin: 15px 0;">
        <button class="secondary" onclick="loadCSV()">üì• Load CSV</button>
        <button class="secondary" onclick="exportCSV()">üì§ Export CSV</button>
    </div>
    <p style="text-align:center; font-size: 14px;">Total Words: <span id="count" style="color:var(--primary); font-weight:bold;">0</span></p>
</div>

<div class="screen" id="manage">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
        <h3>Database</h3>
        <button class="secondary" onclick="go('main')" style="padding: 5px 12px;">Back</button>
    </div>
    <input type="text" id="dbSearch" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;" placeholder="Search..." oninput="renderManageList()">
    <div class="filter-bar">
        <div class="filter-chip active" onclick="setFilter('all', this)">All</div>
        <div class="filter-chip" data-f="failed" onclick="setFilter('failed', this)">Failed</div>
        <div class="filter-chip" data-f="success" onclick="setFilter('success', this)">Success</div>
        <div class="filter-chip" data-f="hidden" onclick="setFilter('hidden', this)">Hidden</div>
    </div>
    <div class="card" id="manageList" style="padding:0; max-height: 60vh; overflow-y: auto;"></div>
</div>

<div class="screen" id="add">
    <h1>Add Word</h1>
    <div class="card">
        <input id="eng" placeholder="English Word" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
        <input id="heb" placeholder="Hebrew Translation" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">
        <button class="primary" style="width:100%" onclick="saveWord()">Save to Cloud</button>
        <button class="secondary" style="width:100%; margin-top:10px" onclick="go('main')">Cancel</button>
    </div>
</div>

<div class="screen" id="practiceSetup">
    <h1>Setup</h1>
    <div class="card">
        <label>Mode:</label>
        <select id="mode" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px;"><option value="recent">Recent (LIFO)</option><option value="all">Random</option></select>
        <label>Count:</label>
        <select id="limit" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px;"><option value="30">30</option><option value="50">50</option><option value="100">100</option><option value="9999">ALL</option></select>
        <label style="display:flex; align-items: center; font-size: 14px;"><input type="checkbox" id="resetProgress" style="margin-right:10px;"> Reset Session (All Words)</label>
        <button class="primary" style="width:100%; margin-top:20px;" onclick="startPractice()">Start Session</button>
    </div>
</div>

<div class="screen" id="practice">
    <div class="card">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div id="progress" style="font-size:12px; font-weight: bold; color: #64748b;"></div>
            <button class="secondary" onclick="speakWord()" style="padding: 6px 10px; font-size:12px;">üîä Speak</button>
        </div>
        <div id="wordDate" style="text-align:center; font-size:10px; color:#94a3b8;"></div>
        <div class="word" id="word"></div>
        <div class="translation" id="translation"></div>
        <div id="options" class="options"></div>

        <div class="vx-buttons" id="vxButtons" style="display:none; gap:10px; justify-content:center; margin-bottom:15px;">
            <button class="primary" style="background:#16a34a; flex:1;" onclick="markV()">Correct V</button>
            <button class="danger" style="flex:1;" onclick="markX()">Failed X</button>
        </div>

        <div id="actionButtons" class="action-grid">
            <button class="secondary" id="showTranslationBtn" onclick="showTranslation()">Translation</button>
            <button class="secondary" id="showOptionsBtn" onclick="showOptions()">Choice</button>
            <button class="primary" id="nextBtn" style="display:none; width: 100%;" onclick="nextWord()">Next ‚Üí</button>
        </div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #f1f5f9;">
        <div class="action-grid" style="gap:5px; margin-bottom:15px;">
            <button class="secondary" style="font-size:11px;" onclick="editWord()">Edit</button>
            <button class="secondary" style="font-size:11px;" onclick="hideWord()">Hide</button>
            <button class="danger" style="font-size:11px; background:#fca5a5" onclick="deleteWordPractice()">Del</button>
        </div>
        <button class="secondary" style="width:100%; font-size: 13px; border: 1px dashed #cbd5e1;" onclick="finishPractice()">üèÅ Finish & Save</button>
    </div>
</div>

<script>
// --- FIREBASE CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyCt0aC_gPhtyi3OkBwGiMZgo8A3CKcoBQc",
    authDomain: "my-words-app-anen.firebaseapp.com",
    projectId: "my-words-app-anen",
    storageBucket: "my-words-app-anen.firebasestorage.app",
    messagingSenderId: "437602984017",
    appId: "1:437602984017:web:d9cc8305c46cf423ee1870",
    measurementId: "G-1E3BLH585J"
};

// Initialization
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
db.enablePersistence().catch(err => console.error("Offline mode failed", err));

let words = [];
let currentUser = null;
let practiceQueue = [], index = 0, score = 0, currentFilter = 'all';

// --- AUTH LOGIC ---
auth.onAuthStateChanged(user => {
    if (user) {
        currentUser = user;
        loadFromCloud();
        go('main');
    } else {
        go('login');
    }
});

async function loginWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try { await auth.signInWithPopup(provider); } 
    catch (e) { document.getElementById('authError').innerText = e.message; }
}

function logout() { auth.signOut(); }

// --- DATA LOGIC ---
async function saveToCloud() {
    if (!currentUser) return;
    await db.collection('users').doc(currentUser.uid).set({ words });
    document.getElementById('count').innerText = words.length;
}

async function loadFromCloud() {
    const doc = await db.collection('users').doc(currentUser.uid).get();
    if (doc.exists) {
        words = doc.data().words || [];
    } else {
        // ◊ê◊ù ◊û◊©◊™◊û◊© ◊ó◊ì◊©, ◊†◊ë◊ì◊ï◊ß ◊ê◊ù ◊ô◊© ◊ú◊ï ◊û◊ô◊ì◊¢ ◊û◊ß◊ï◊û◊ô ◊ô◊©◊ü ◊ï◊†◊û◊ô◊® ◊ê◊ï◊™◊ï ◊ú◊¢◊†◊ü
        const local = localStorage.words;
        if(local) { words = JSON.parse(local); saveToCloud(); }
    }
    document.getElementById('count').innerText = words.length;
}

function save() { saveToCloud(); }

// --- APP LOGIC ---
function go(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

function openManage() { currentFilter = 'all'; renderManageList(); go('manage'); }
function setFilter(type, el) { currentFilter = type; document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); renderManageList(); }

function toggleFlag(eng, flag) {
    let w = words.find(x => x.e === eng);
    if(w) {
        if(flag === 'failed') w.failed = !w.failed;
        if(flag === 'shown') w.shown = !w.shown;
        if(flag === 'hidden') w.hidden = !w.hidden;
        save(); renderManageList();
    }
}

function renderManageList() {
    const container = document.getElementById('manageList');
    const query = document.getElementById('dbSearch').value.toLowerCase();
    let filtered = words.filter(w => w.e.toLowerCase().includes(query) || w.h.toLowerCase().includes(query));
    if (currentFilter === 'failed') filtered = filtered.filter(w => w.failed);
    if (currentFilter === 'success') filtered = filtered.filter(w => w.shown && !w.failed);
    if (currentFilter === 'hidden') filtered = filtered.filter(w => w.hidden);

    let html = '';
    filtered.forEach(w => {
        html += `<div class="word-item">
            <div class="word-top">
                <div><strong>${w.e}</strong> - ${w.h}</div>
                <button class="danger" style="padding:2px 8px; font-size:10px;" onclick="confirmDeletion('${w.e}')">Delete</button>
            </div>
            <div class="word-actions">
                <button class="action-btn ${w.failed ? 'active-failed' : ''}" onclick="toggleFlag('${w.e}','failed')">Failed X</button>
                <button class="action-btn ${w.shown ? 'active-success' : ''}" onclick="toggleFlag('${w.e}','shown')">Success V</button>
                <button class="action-btn ${w.hidden ? 'active-hidden' : ''}" onclick="toggleFlag('${w.e}','hidden')">Hidden</button>
            </div>
        </div>`;
    });
    container.innerHTML = html || '<p style="text-align:center; padding:20px;">Empty</p>';
}

function confirmDeletion(e) { if(confirm(`Delete "${e}"?`)) { words = words.filter(w => w.e !== e); save(); renderManageList(); } }

function saveWord(){
    let e = eng.value.trim(), h = heb.value.trim();
    if(!e || !h) return;
    words.unshift({ e, h, hidden: false, shown: false, failed: false, created: new Date().toISOString() });
    save(); eng.value=heb.value=""; go('main');
}

function startPractice() {
    let limit = parseInt(document.getElementById('limit').value);
    if(document.getElementById('resetProgress').checked) { words.forEach(w => w.shown = false); document.getElementById('resetProgress').checked = false; }
    let base = words.filter(w => !w.hidden);
    if (base.length > 0 && base.every(w => w.shown)) words.forEach(w => w.shown = false);
    let gA = base.filter(w => w.failed);
    let gB = base.filter(w => !w.failed && !w.shown);
    if(document.getElementById('mode').value === 'recent') gB.sort((a,b) => new Date(b.created) - new Date(a.created));
    else gB.sort(() => 0.5 - Math.random());
    practiceQueue = [...gA, ...gB].slice(0, limit).sort(() => 0.5 - Math.random());
    if(!practiceQueue.length) return alert("No words!");
    index = 0; score = 0; loadWord(); go('practice');
}

function loadWord() {
    let w = practiceQueue[index];
    progress.innerText = `${index+1} / ${practiceQueue.length}`;
    word.innerText = w.e; translation.innerText = ""; options.innerHTML = "";
    document.getElementById('vxButtons').style.display='none';
    document.getElementById('nextBtn').style.display='none';
    document.getElementById('showTranslationBtn').style.display='inline-block';
    document.getElementById('showOptionsBtn').style.display='inline-block';
}

function showTranslation() { translation.innerText = practiceQueue[index].h; prepareConfirm(); }
function showOptions() {
    let corr = practiceQueue[index].h;
    let pool = words.map(w => w.h).filter(h => h !== corr).sort(() => 0.5 - Math.random());
    let opts = [corr, ...pool.slice(0,3)].sort(() => 0.5 - Math.random());
    options.innerHTML = "";
    opts.forEach(t => {
        let b = document.createElement('div'); b.className = 'option'; b.innerText = t;
        b.onclick = () => {
            document.querySelectorAll('.option').forEach(el => el.onclick = null);
            if(t === corr) b.classList.add('correct');
            else { b.classList.add('wrong'); [...options.children].find(o => o.innerText === corr).classList.add('correct'); }
            prepareConfirm();
        };
        options.appendChild(b);
    });
}
function prepareConfirm() { document.getElementById('showTranslationBtn').style.display = 'none'; document.getElementById('showOptionsBtn').style.display = 'none'; document.getElementById('vxButtons').style.display = 'flex'; }
function markV() { let m = words.find(w => w.e === practiceQueue[index].e); if(m){m.failed=false; m.shown=true;} score++; finishStep(); }
function markX() { let m = words.find(w => w.e === practiceQueue[index].e); if(m){m.failed=true; m.shown=false;} finishStep(); }
function finishStep() { document.getElementById('vxButtons').style.display = 'none'; document.getElementById('nextBtn').style.display = 'block'; }
function nextWord() { index++; if(index >= practiceQueue.length) { save(); alert(`Session Done! ${score}/${practiceQueue.length}`); go('main'); } else loadWord(); }
function finishPractice() { save(); go('main'); }
function speakWord() { let u = new SpeechSynthesisUtterance(practiceQueue[index].e); u.lang = 'en-US'; speechSynthesis.speak(u); }

// CSV
function parseCSVLine(t) { let p = [], c = '', q = false; for (let i=0; i<t.length; i++) { if (t[i]==='"') q=!q; else if (t[i]===',' && !q) { p.push(c.trim()); c=''; } else c+=t[i]; } p.push(c.trim()); return p.map(x => x.replace(/^"|"$/g, '').trim()); }
function loadCSV() {
    let i = document.createElement('input'); i.type='file'; i.accept='.csv';
    i.onchange = e => {
        let r = new FileReader(); r.onload = ev => {
            let l = ev.target.result.split(/\r?\n/);
            l.slice(1).forEach(line => {
                let p = parseCSVLine(line); if(p.length < 2) return;
                if(!words.some(w => w.e.toLowerCase() === p[0].toLowerCase())) words.push({ e:p[0], h:p[1], hidden:false, shown:false, failed:false, created:new Date().toISOString() });
            });
            save(); alert("Uploaded & Synced!");
        }; r.readAsText(e.target.files[0], 'UTF-8');
    }; i.click();
}
function exportCSV() {
    let c = "English,Hebrew\n"; words.forEach(w => c += `"${w.e}","${w.h}"\n`);
    let a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c], {type:'text/csv'})); a.download = 'words.csv'; a.click();
}
function resetDatabase() { if(confirm("Clear All Cloud Data?")) { words=[]; save(); } }
function hideWord(){ let m = words.find(w => w.e === practiceQueue[index].e); if(m) m.hidden = true; save(); nextWord(); }
function deleteWordPractice(){ if(confirm("Delete?")) { words = words.filter(w => w.e !== practiceQueue[index].e); save(); practiceQueue.splice(index,1); if(index >= practiceQueue.length) go('main'); else loadWord(); } }
function editWord(){ let w = practiceQueue[index]; let ne = prompt("Eng", w.e), nh = prompt("Heb", w.h); if(ne && nh) { let m = words.find(x => x.e === w.e); if(m) { m.e=ne; m.h=nh; } w.e=ne; w.h=nh; save(); loadWord(); } }
</script>
</body>
</html>
