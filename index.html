<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Words App - Manage Pro</title>

<style>
:root {
    --primary: #2563eb;
    --primary-hover: #1d4ed8;
    --danger: #dc2626;
    --success: #16a34a;
    --warning: #f59e0b;
    --bg: #f8fafc;
    --card: #ffffff;
    --text: #1e293b;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg);
  margin: 0;
  color: var(--text);
  direction: ltr;
}

.screen { display: none; max-width: 700px; margin: auto; padding: 20px; animation: fadeIn 0.3s; }
.screen.active { display: block; }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

h1 { text-align: center; color: var(--primary); }

.card { 
    background: var(--card); 
    padding: 25px; 
    border-radius: 16px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    margin-bottom: 20px;
}

button { 
    padding: 12px 18px; 
    font-size: 15px; 
    border-radius: 10px; 
    border: none; 
    cursor: pointer; 
    transition: all 0.2s;
    font-weight: 500;
}

button:active { transform: scale(0.96); }

.primary { background: var(--primary); color: #fff; }
.secondary { background: #e2e8f0; color: #475569; }
.danger { background: var(--danger); color: #fff; }

.main-buttons button { width: 100%; max-width: 300px; display: block; margin: 12px auto; }

/* Management & Filters */
.search-input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #e2e8f0; font-size: 16px; outline: none; margin-bottom: 10px; box-sizing: border-box;}

.filter-bar { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
.filter-chip { 
    padding: 6px 12px; border-radius: 20px; font-size: 12px; background: #e2e8f0; 
    color: #475569; cursor: pointer; white-space: nowrap; transition: 0.2s; border: 2px solid transparent;
}
.filter-chip.active { border-color: #94a3b8; font-weight: bold; }
.filter-chip[data-f="failed"].active { background: #fee2e2; color: #b91c1c; border-color: #ef4444; }
.filter-chip[data-f="success"].active { background: #dcfce7; color: #15803d; border-color: #22c55e; }
.filter-chip[data-f="hidden"].active { background: #fef3c7; color: #92400e; border-color: #f59e0b; }

.word-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fff; border-bottom: 1px solid #f1f5f9; }
.word-meta { font-size: 11px; color: #94a3b8; }
.badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-weight: bold; }
.badge-failed { background: #fee2e2; color: #b91c1c; }
.badge-success { background: #dcfce7; color: #15803d; }
.badge-hidden { background: #fef3c7; color: #92400e; }

/* Practice */
#wordDate { text-align: center; font-size: 12px; color: #94a3b8; margin-bottom: -15px; }
.word { font-size: 38px; text-align: center; margin: 20px 0; font-weight: bold; }
.translation { font-size: 24px; text-align: center; color: var(--primary); min-height: 1.5em; }
.options .option { padding: 14px; border-radius: 10px; background: #f1f5f9; margin: 8px 0; cursor: pointer; text-align: center; border: 2px solid transparent; }
.option.correct { background: #dcfce7; border-color: #22c55e; }
.option.wrong { background: #fee2e2; border-color: #ef4444; }

.vx-buttons { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
.footer { text-align: center; font-size: 12px; margin-top: 40px; color: #94a3b8; }

label { font-weight: bold; display: block; margin-bottom: 5px; color: #475569; }
input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; }
</style>
</head>

<body>

<div class="screen active" id="main">
    <h1>My Words App</h1>
    <div class="main-buttons">
        <button class="primary" onclick="go('add')">+ Add New Word</button>
        <button class="primary" onclick="go('practiceSetup')">ðŸŽ¯ Practice Now</button>
        <button class="secondary" onclick="openManage()">ðŸ“‹ Manage Database</button>
        <hr style="border:0; border-top:1px solid #e2e8f0; margin: 20px 0;">
        <button class="secondary" onclick="loadCSV()">ðŸ“¥ Load CSV</button>
        <button class="secondary" onclick="exportCSV()">ðŸ“¤ Export CSV</button>
        <button class="danger" style="opacity: 0.7;" onclick="resetDatabase()">Reset Database</button>
    </div>
    <p style="text-align:center; font-weight: 500;">
        Words in collection: <span id="count" style="color:var(--primary)">0</span>
    </p>
    <div class="footer">Designed by Eli Anenburg & AI Friend</div>
</div>

<div class="screen" id="manage">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
        <h2>Manage Database</h2>
        <button class="secondary" onclick="go('main')">Back</button>
    </div>
    
    <input type="text" id="dbSearch" class="search-input" placeholder="Search English or Hebrew..." oninput="renderManageList()">
    
    <div class="filter-bar" id="filterBar">
        <div class="filter-chip active" onclick="setFilter('all', this)">All</div>
        <div class="filter-chip" data-f="failed" onclick="setFilter('failed', this)">Failed (X)</div>
        <div class="filter-chip" data-f="success" onclick="setFilter('success', this)">Success (V)</div>
        <div class="filter-chip" data-f="hidden" onclick="setFilter('hidden', this)">Hidden</div>
    </div>

    <div class="card" id="manageList" style="padding:0; max-height: 500px; overflow-y: auto;"></div>
</div>

<div class="screen" id="add">
    <h1>Add Word</h1>
    <div class="card">
        <input id="eng" placeholder="English Word">
        <input id="heb" placeholder="Hebrew Translation">
        <button class="primary" style="width:100%" onclick="saveWord()">Save to Database</button>
        <button class="secondary" style="width:100%; margin-top:10px" onclick="go('main')">Cancel</button>
    </div>
</div>

<div class="screen" id="practiceSetup">
    <h1>Practice Setup</h1>
    <div class="card">
        <label>Exercise Type:</label>
        <select id="mode">
            <option value="recent">Recent Words (LIFO)</option>
            <option value="all">All Words (Random)</option>
        </select>

        <label>Word Count:</label>
        <select id="limit">
            <option value="30">30 words</option>
            <option value="50">50 words</option>
            <option value="100">100 words</option>
            <option value="9999">ALL available</option>
        </select>

        <label style="display:flex; align-items: center; cursor: pointer; margin-top: 10px;">
            <input type="checkbox" id="resetProgress" style="width:auto; margin-right:10px;">
            <span>Reset Progress (include learned words)</span>
        </label>
        
        <button class="primary" style="width:100%; margin-top: 20px;" onclick="startPractice()">Start Session</button>
        <button class="secondary" style="width:100%; margin-top:10px" onclick="go('main')">Back</button>
    </div>
</div>

<div class="screen" id="practice">
    <div class="card">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div id="progress" style="font-weight: bold; color: #64748b;"></div>
            <button class="secondary" onclick="speakWord()" style="padding: 8px 12px;">ðŸ”Š Listen</button>
        </div>
        <div id="wordDate"></div>
        <div class="word" id="word"></div>
        <div class="translation" id="translation"></div>
        <div id="options" class="options"></div>

        <div class="vx-buttons" id="vxButtons" style="display:none;">
            <button class="primary" style="background:#22c55e" onclick="markV()">Correct (V)</button>
            <button class="danger" onclick="markX()">Incorrect (X)</button>
        </div>

        <div id="actionButtons" style="text-align:center; margin-top:20px;">
            <button class="secondary" id="showTranslationBtn" onclick="showTranslation()">Show Translation</button>
            <button class="secondary" id="showOptionsBtn" onclick="showOptions()">Multiple Choice</button>
            <button class="primary" id="nextBtn" style="display:none; width: 100%;" onclick="nextWord()">Next Word â†’</button>
        </div>
        <hr style="margin: 25px 0; border: 0; border-top: 1px solid #f1f5f9;">
        <div style="display: flex; justify-content: space-between; gap: 10px;">
            <button class="secondary" style="flex:1; font-size:12px;" onclick="editWord()">Edit</button>
            <button class="secondary" style="flex:1; font-size:12px;" onclick="hideWord()">Hide</button>
            <button class="danger" style="flex:1; font-size:12px; background:#fca5a5" onclick="deleteWordPractice()">Delete</button>
        </div>
        <button class="secondary" style="width:100%; margin-top:10px; font-size: 12px;" onclick="finishPractice()">Finish Practice</button>
    </div>
</div>

<script>
let words = JSON.parse(localStorage.words || "[]");
let practiceQueue = [];
let index = 0;
let score = 0;
let currentFilter = 'all';

function save() {
  localStorage.words = JSON.stringify(words);
  document.getElementById('count').innerText = words.length;
}

function go(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// MANAGEMENT & FILTERS
function openManage() { 
    document.getElementById('dbSearch').value = ""; 
    currentFilter = 'all';
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    document.querySelector('.filter-chip').classList.add('active');
    renderManageList(); 
    go('manage'); 
}

function setFilter(type, el) {
    currentFilter = type;
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    renderManageList();
}

function renderManageList() {
    const container = document.getElementById('manageList');
    const query = document.getElementById('dbSearch').value.toLowerCase();
    
    let filtered = words.filter(w => w.e.toLowerCase().includes(query) || w.h.toLowerCase().includes(query));
    
    // Apply status filter
    if (currentFilter === 'failed') filtered = filtered.filter(w => w.failed);
    if (currentFilter === 'success') filtered = filtered.filter(w => w.shown && !w.failed);
    if (currentFilter === 'hidden') filtered = filtered.filter(w => w.hidden);

    if(filtered.length === 0) { container.innerHTML = '<div style="padding:20px; text-align:center">No matching words.</div>'; return; }
    
    let html = '';
    filtered.forEach(w => {
        let d = new Date(w.created);
        html += `<div class="word-item">
            <div class="word-info">
                <strong>${w.e}</strong> - ${w.h}
                ${w.failed ? '<span class="badge badge-failed">FAILED</span>' : ''}
                ${(w.shown && !w.failed) ? '<span class="badge badge-success">SUCCESS</span>' : ''}
                ${w.hidden ? '<span class="badge badge-hidden">HIDDEN</span>' : ''}
                <div class="word-meta">Added: ${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}</div>
            </div>
            <button class="danger" style="padding: 5px 10px;" onclick="confirmDeletion('${w.e}')">X</button>
        </div>`;
    });
    container.innerHTML = html;
}

function confirmDeletion(e) { if(confirm(`Delete "${e}"?`)) { words = words.filter(w => w.e !== e); save(); renderManageList(); } }

function saveWord(){
  let eVal = eng.value.trim();
  let hVal = heb.value.trim();
  if(!eVal || !hVal) return alert("Fill both fields");
  if(words.some(w => w.e.toLowerCase().trim() === eVal.toLowerCase())) return alert("Exists!");
  words.unshift({ e: eVal, h: hVal, hidden: false, shown: false, failed: false, created: new Date().toISOString() });
  save(); eng.value=heb.value=""; go('main');
}

// LOGIC ENGINE
function startPractice() {
    let limitVal = parseInt(document.getElementById('limit').value);
    let practiceMode = document.getElementById('mode').value;

    if(document.getElementById('resetProgress').checked) {
        words.forEach(w => w.shown = false);
        document.getElementById('resetProgress').checked = false;
    }

    let basePool = words.filter(w => !w.hidden);

    if (basePool.length > 0 && basePool.every(w => w.shown)) {
        alert("Cycle complete! Starting new cycle.");
        words.forEach(w => w.shown = false);
        basePool.forEach(w => w.shown = false);
    }

    let groupA = basePool.filter(w => w.failed);
    let groupB_Pool = basePool.filter(w => !w.failed && !w.shown);
    
    if(practiceMode === 'recent') {
        groupB_Pool.sort((a,b) => new Date(b.created) - new Date(a.created));
    } else {
        groupB_Pool.sort(() => 0.5 - Math.random());
    }

    let combined = [...groupA, ...groupB_Pool].slice(0, limitVal);
    practiceQueue = combined.sort(() => 0.5 - Math.random());

    if(practiceQueue.length === 0) return alert("No words available.");
    index = 0; score = 0; loadWord(); go('practice');
}

function loadWord() {
    let w = practiceQueue[index];
    progress.innerText = `Word ${index+1} of ${practiceQueue.length}`;
    let d = new Date(w.created);
    document.getElementById('wordDate').innerText = `Added on: ${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    word.innerText = w.e;
    translation.innerText = "";
    options.innerHTML = "";
    document.getElementById('vxButtons').style.display='none';
    document.getElementById('nextBtn').style.display='none';
    document.getElementById('showTranslationBtn').style.display='inline-block';
    document.getElementById('showOptionsBtn').style.display='inline-block';
}

function showTranslation() { translation.innerText = practiceQueue[index].h; prepareForConfirmation(); }

function showOptions() {
    let correct = practiceQueue[index].h;
    let pool = words.map(w => w.h).filter(h => h !== correct);
    pool.sort(() => 0.5 - Math.random());
    let opts = [correct, ...pool.slice(0,3)].sort(() => 0.5 - Math.random());
    options.innerHTML = "";
    opts.forEach(t => {
        let b = document.createElement('div'); b.className = 'option'; b.innerText = t;
        b.onclick = () => {
            document.querySelectorAll('.option').forEach(el => el.onclick = null);
            if(t === correct) b.classList.add('correct');
            else { b.classList.add('wrong'); [...options.children].find(o => o.innerText === correct).classList.add('correct'); }
            prepareForConfirmation();
        };
        options.appendChild(b);
    });
}

function prepareForConfirmation() {
    document.getElementById('showTranslationBtn').style.display = 'none';
    document.getElementById('showOptionsBtn').style.display = 'none';
    document.getElementById('vxButtons').style.display = 'flex';
}

function markV() {
    let master = words.find(w => w.e === practiceQueue[index].e);
    if(master) { master.failed = false; master.shown = true; }
    score++;
    finalizeStep();
}

function markX() {
    let master = words.find(w => w.e === practiceQueue[index].e);
    if(master) { master.failed = true; master.shown = false; }
    finalizeStep();
}

function finalizeStep() {
    document.getElementById('vxButtons').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'block';
}

function nextWord() {
    index++;
    if(index >= practiceQueue.length) { save(); alert(`Session Ended! Score: ${score}/${practiceQueue.length}`); go('main'); } else { loadWord(); }
}

function finishPractice() { save(); go('main'); }
function speakWord() { let u = new SpeechSynthesisUtterance(practiceQueue[index].e); u.lang = 'en-US'; speechSynthesis.speak(u); }

// CSV TOOLS
function parseCSVLine(text) {
    let parts = []; let current = ''; let inQuotes = false;
    for (let i = 0; i < text.length; i++) {
        if (text[i] === '"') inQuotes = !inQuotes;
        else if (text[i] === ',' && !inQuotes) { parts.push(current.trim()); current = ''; }
        else current += text[i];
    }
    parts.push(current.trim());
    return parts.map(p => p.replace(/^"|"$/g, '').trim());
}

function loadCSV() {
    let i = document.createElement('input'); i.type='file'; i.accept='.csv';
    i.onchange = e => {
        let file = e.target.files[0]; if(!file) return;
        let reader = new FileReader();
        reader.onload = ev => {
            let lines = ev.target.result.split(/\r?\n/);
            let added = 0, skipped = 0;
            for (let idx = 1; idx < lines.length; idx++) {
                let line = lines[idx].trim(); if(!line) continue;
                let p = parseCSVLine(line); if(p.length < 2) continue;
                let english = p[0], hebrew = p[1], dateStr = p[2];
                if(words.some(w => w.e.toLowerCase().trim() === english.toLowerCase())) { skipped++; continue; }
                let finalDate = new Date().toISOString();
                if(dateStr && dateStr.includes('/')) {
                    let dp = dateStr.split('/');
                    if(dp.length===3) {
                        let dObj = new Date(dp[2], dp[1]-1, dp[0]);
                        if(!isNaN(dObj.getTime())) finalDate = dObj.toISOString();
                    }
                }
                words.push({ e: english, h: hebrew, hidden: false, shown: false, failed: false, created: finalDate });
                added++;
            }
            save(); alert(`Import Finish!\nAdded: ${added}\nSkipped: ${skipped}`); location.reload();
        };
        reader.readAsText(file, 'UTF-8');
    }; i.click();
}

function exportCSV(){
    let csv = "\ufeffEnglish,Hebrew,Date,Hidden\n";
    words.forEach(w => { 
        let d = new Date(w.created); 
        csv += `"${w.e}","${w.h}","${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}",${w.hidden}\n`; 
    });
    let a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8'}));
    a.download = `words_export.csv`; a.click();
}

function resetDatabase(){ if(confirm("ERASE ALL DATA?")) { words=[]; save(); location.reload(); } }

function hideWord(){ let m = words.find(w => w.e === practiceQueue[index].e); if(m) m.hidden = true; save(); nextWord(); }
function deleteWordPractice(){ if(confirm("Delete?")) { words = words.filter(w => w.e !== practiceQueue[index].e); save(); practiceQueue.splice(index,1); if(index >= practiceQueue.length) go('main'); else loadWord(); } }
function editWord(){ 
    let w = practiceQueue[index]; let ne = prompt("Edit English", w.e), nh = prompt("Edit Hebrew", w.h); 
    if(ne && nh) { let m = words.find(x => x.e === w.e); if(m) { m.e=ne; m.h=nh; } w.e=ne; w.h=nh; save(); loadWord(); } 
}

document.getElementById('count').innerText = words.length;
</script>
</body>
</html>
